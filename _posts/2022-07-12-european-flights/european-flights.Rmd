---
title: "How to write a function in R and apply it to a data frame using map functions from {purr}"
description: |
  Demonstrating writing a function and applying it to a data frame using the
  #TidyTuesday data set for week 28 of 2022
    (12/7/2022): "European Flights"
author:
  - name: Ronan Harrington
    url: https://github.com/rnnh/
date: 2022-07-12
repository_url: https://github.com/rnnh/TidyTuesday/
preview: european-flights_files/figure-html5/fig1-1.png
output:
  distill::distill_article:
    self_contained: false
    toc: true
---


````{r knitr, include=FALSE}
knitr::opts_chunk$set(include = TRUE)
knitr::opts_chunk$set(fig.height = 6)
knitr::opts_chunk$set(fig.width = 9)
```

## Introduction

In this post, the [European Flights](https://github.com/rfordatascience/tidytuesday/blob/master/data/2022/2022-07-12/readme.md) data set is used to illustrate defining a function in [R](https://www.r-project.org/) and applying it to a data frame using map functions from [{purr}](https://www.r-project.org/).
The full source for this blog post is [available on GitHub](https://github.com/rnnh/TidyTuesday).

## Setup

Loading the [R](https://www.r-project.org/) libraries and
[data set](https://github.com/rfordatascience/tidytuesday/blob/master/data/2022/2022-07-12/readme.md).

```{r setup}
# Loading libraries
library(tidytuesdayR)
library(tidyverse)
library(tidytext)
library(ggthemes)

# Loading data
tt <- tt_load("2022-07-12")
```

## Defining a function to tidy variables and applying it with purr::map

```{r map}
# Printing a summary of the flights data frame
tt$flights
# Printing a summary of the shape of the data frame
paste("tt$flights has", nrow(tt$flights), "rows and", ncol(tt$flights),
  "columns.")

# Defining a function to tidy the flights data set
tidy_flights_per_airport <- function(variable){
  tt$flights %>% 
    # Selecting columns, including the column with the name input as "variable"
    ## "all_of()" is used for error handling: if a column with the name matching
    ## "variable" is not available in tt$flights, the function will give an error
    select(FLT_DATE, APT_NAME, all_of(variable)) %>% 
    # Adding a "flight_type" column, with "variable" as a string as its value
    mutate(flight_type = as.character(variable)) %>% 
    # Renaming the input "variable" column to "number_of_flights"
    rename("number_of_flights" = variable)
}

# Selecting column names with flight types (arrivals, departures, total flights)
flight_types <- colnames(tt$flights)[8:13]
# Printing the flight types
flight_types

# Applying the tidying function to the flight types vector using purr::map()
tidy_flights_list <- map(flight_types, tidy_flights_per_airport)
```

## Binding the tidied variable rows into a data frame with purr::map_df

```{r map_df}
# Binding the tidy version of each flight type by row using purr::map_df
tidy_flights <- map_df(tidy_flights_list, rbind)

# Printing a summary of the tidy flights data frame
tidy_flights
# Printing a summary of the shape of the data frame
paste("tidy_flights has", nrow(tidy_flights), "rows and", ncol(tidy_flights),
  "columns.")
```

The `tidy_flights` data frame is now in a [tidy format](https://tidyr.tidyverse.org/articles/tidy-data.html).

## Plotting the distribution of arrivals and departures across the top six airports

```{r fig1, fig.cap = "Box plots of daily arrival and depature distribution across top six airports."}
## Selecting the top 6 airports by total number of flights on the latest flight
## date
top_airports <- tidy_flights %>%
  filter(flight_type == "FLT_TOT_1") %>%
  filter(FLT_DATE == max(FLT_DATE)) %>%
  slice_max(order_by = number_of_flights, n = 6)

# Changing "flight_type" to a factor with descriptive levels
tidy_flights$flight_type <- as.factor(tidy_flights$flight_type)
levels(tidy_flights$flight_type) <- c("Arrivals", "Arrivals (Airport Operator)",
  "Departures", "Departures (Airport Operator)", "Total", "Total (Airport Operator")

# Plotting the distribution of arrivals and departures for the top airports
tidy_flights %>%
  filter(APT_NAME %in% top_airports$APT_NAME) %>%
  filter(flight_type %in% c("Arrivals", "Departures")) %>%
  ggplot(aes(x = APT_NAME, y = number_of_flights, colour = flight_type)) +
  geom_boxplot() +
  theme_solarized() +
  scale_colour_discrete() +
  labs(title = "Distribution of daily arrivals and depatures across six airports",
    x = "Airport", y = "Flights", legend = "Flight type")
```

## See also

- [Reshaping data using pivot functions](https://tidytuesday.netlify.app/posts/2022-07-05-sf-rents/)